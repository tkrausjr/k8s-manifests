<source>
  @id in_tail_kube_apiserver_logs
  @type tail
  format json
  tag kubernetes.audit
  path /var/log/kubernetes/kube-apiserver.log
  pos_file /var/log/fluentd-kube-apiserver.log.pos
  read_from_head true
  <parse>
    @type json
    keep_time_key true
    time_key timestamp
    time_format %Y-%m-%dT%T.%L%Z
  </parse>
</source>

<filter kubernetes.audit>
  @type parser
  reserve_data true
  key_name responseStatus
  hash_value_field responseStatus
  remove_keys source
  <parse>
    @type json
  </parse>
</filter>

#<filter kubernetes.audit>
#  @type record_transformer
#  <record>
#     pod_name "#{record['object']['metadata']['name']}"
#     namespace "#{record['object']['metadata']['namespace']}"
#  </record>
#</filter>

# VMware Aria Operations For Logs doesn't support ingesting `source` as a field name, get rid of it
#<filter kube-audit>
#  @type parser
#  @id filter_kube_audit_logs
#  reserve_data true
#  remove_keys source
#  read_from_head true
#    <parse>
#      @type json
#    </parse>
#</filter>

#<match kubernetes.*>
#  @type stdout
#</match>


<match kubernetes.*> 
  @type vmware_loginsight
  host 10.160.53.44
  port 9543
  scheme https
  ssl_verify false
  raise_on_error true
  log_text_keys ["annotations_authorization_k8s_io_reason", "log","msg","message"]
  <buffer>
    @type file
    path /var/log/app_${tag}_${chunk_id}
    append true
    chunk_limit_records 300
    flush_interval 10s
    retry_max_times 5
  </buffer>
</match>